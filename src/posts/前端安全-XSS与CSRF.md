---
title: 前端安全--XSS与CSRF
titleImage:
categories:
  - Software Development
date: 2020-03-14 16:05:36
tags:
  - 前端
---

在 Web 安全领域中，XSS 和 CSRF 是最常见的攻击方式

## XSS

### 概述

XSS(Cross Site Script, 跨站脚本攻击),缩写原本是 CSS，但为了和层叠样式表(Cascading Style Sheet)有所区分，因而在安全领域叫做 XSS。

XSS 攻击是指攻击者在网站上注入恶意的客户端代码，通过恶意脚本对客户端网页进行篡改，从而在用户浏览网页时，对用户浏览器进行控制或者获取用户隐私数据的一种攻击方式。

### 分类

1. 反射型(非持久型)
这种攻击方式往往需要攻击者诱使用户点击一个恶意链接，或者提交一个表单，或者进入一个恶意网站时，注入脚本进入被攻击者的网站。

被攻击者点击这个恶意链接，此时在攻击者的后台有处理对这个恶意链接请求的服务，返回恶意脚本在被攻击者的客户端执行，或者注入获取用户隐私的脚本

2. 存储型(持久型)
比较常见的一个场景是攻击者在社区或论坛上写下一篇包含恶意 JavaScript 代码的文章或评论，文章或评论发表后，所有访问该文章或评论的用户，都会在他们的浏览器中执行这段恶意的 JavaScript 代码。

3. 基于DOM
基于 DOM 的 XSS 攻击是指通过恶意脚本修改页面的 DOM 结构，是纯粹发生在客户端的攻击。

### 防范措施

1. 现在主流的浏览器内置了防范 XSS 的措施，例如 CSP

2. HttpOnly 防止劫取 Cookie。

严格来说，HttpOnly 并非阻止 XSS 攻击，而是能阻止 XSS 攻击后的 Cookie 劫持攻击。

3. 输入检查--不要相信任何用户的输入

对于用户的任何输入要进行检查、过滤和转义。建立可信任的字符和 HTML 标签白名单，对于不在白名单之列的字符或者标签进行过滤或编码。

在 XSS 防御中，输入检查一般是检查用户输入的数据中是否包含 <，> 等特殊字符，如果存在，则对特殊字符进行过滤或编码，这种方式也称为 XSS Filter。

4. 输出检查

除富文本的输出外，在变量输出到 HTML 页面时，可以使用编码或转义的方式来防御 XSS 攻击。


## CSRF

### 概述

CSRF(Cross Site Request Forgery, 跨站请求伪造), 是一种劫持受信任用户向服务器发送非预期请求的攻击方式。

通常情况下，CSRF 攻击是攻击者借助受害者的 Cookie 骗取服务器的信任，可以在受害者毫不知情的情况下以受害者名义伪造请求发送给受攻击服务器，从而在并未授权的情况下执行在权限保护之下的操作。

### 过程

假设有一个bbs: www.xxbbs.com

用户登录之后，服务器设置cookie: res.setHeader('Set-Cookie', ['user=xxx;expires=xxxxxxxx'])

用户发起GET请求，删除id为123456帖子: www.xxbbs.com/content/delete/123456

此时CSRF攻击者构造了某个页面: 

    <img src="www.xxbbs.com/content/delete/123456">

该页面使用了一个 img 标签，其地址指向了删除用户帖子的链接

如果用户点击了这个页面，返回论坛刷新，会发现id为123456的帖子已经被删除。

纵观整个攻击过程，攻击者借助受害者的 Cookie 骗取服务器的信任，但`并不能拿到 Cookie`，也`看不到 Cookie 的内容`。而对于服务器返回的结果，由于浏览器同源策略的限制，`攻击者也无法进行解析`。因此，`攻击者无法从返回的结果中得到任何东西`，他所能做的就是给服务器发送请求，以执行请求中所描述的命令，在`服务器端直接改变数据的值，而非窃取服务器中的数据`。

但若 CSRF 攻击的目标并不需要使用 Cookie，则也不必顾虑浏览器的 Cookie 策略了。

### 防范措施

1. 验证码

验证码被认为是对抗 CSRF 攻击最简洁而有效的防御方法。

从上述示例中可以看出，CSRF 攻击往往是在用户不知情的情况下构造了网络请求。而验证码会强制用户必须与应用进行交互，才能完成最终请求。因为通常情况下，验证码能够很好地遏制 CSRF 攻击。

但验证码并不是万能的，因为出于用户考虑，不能给网站所有的操作都加上验证码。因此，验证码只能作为防御 CSRF 的一种辅助手段，而不能作为最主要的解决方案。

2. Referer Check

根据 HTTP 协议，在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。通过 Referer Check，可以检查请求是否来自合法的"源"。

比如，如果用户要删除自己的帖子，那么先要登录 www.xxbbs.com，然后找到对应的页面，发起删除帖子的请求。此时，Referer 的值是 http://www.xxbbs.com；当请求是从 www.csrfbbs.com 发起时，Referer 的值是 http://www.csrfbbs.com 了。

因此，要防御 CSRF 攻击，只需要对于每一个删帖请求验证其 Referer 值，如果是以 www.xxbbs.com 开头的域名，则说明该请求是来自网站自己的请求，是合法的。如果 Referer 是其他网站的话，则有可能是 CSRF 攻击，可以拒绝该请求。

注：Referer Check还有一项用途就是防止图片盗链

3. Token验证

CSRF 攻击之所以能够成功，是因为攻击者可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于 Cookie 中，因此攻击者可以在不知道这些验证信息的情况下直接利用用户自己的 Cookie 来通过安全验证。

要抵御 CSRF，关键在于在请求中放入攻击者所不能伪造的信息，并且该信息不存在于 Cookie 之中。可以在 HTTP 请求中以`参数的形式加入一个随机产生的 token`，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。
