<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta charset="UTF-8"><title>Effective C++ 4 | LI XUETAO</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
<link href="https://fonts.googleapis.com/css?family=Amatic+SC|Lato|Source+Sans+Pro&display=swap" rel="stylesheet"></head><body><div id="layout-page"><nav id="layout-menu"><div class="other-page hide"><a href="/about">About</a><a href="/archives">Archives</a></div><div class="responsive-pad"></div><div id="mega-head"><a href="/">LI XUETAO</a></div><div class="layout-socialmedia hide"><a class="link-item main-link-item" title="Instagram" href="https://www.instagram.com/lixuetaoleo/"><i class="iconfont icon-instagram"></i></a><a class="link-item main-link-item" title="Twitter" href="https://twitter.com/lixuetaoleo"><i class="iconfont icon-twitter"></i></a><a class="link-item main-link-item" title="Weibo" href="https://weibo.com/u/1791741344"><i class="iconfont icon-weibo"></i></a><a class="link-item main-link-item" title="GitHub" href="https://github.com/lixuetaoleo"><i class="iconfont icon-github"></i></a></div><div class="responsive-bar" onclick="toggle(this)">≡</div></nav><div id="content"><article id="post"><h1>Effective C++ 4</h1><time class="created-date" datetime="2019-11-06T12:46:03.000Z">2019-11-06</time><h2 id="Item-10：令-operator-返回一个reference-to-this"><a href="#Item-10：令-operator-返回一个reference-to-this" class="headerlink" title="Item 10：令 operator= 返回一个reference to *this"></a>Item 10：令 operator= 返回一个reference to *this</h2><ol>
<li>在重载”+=”和”=”操作符时，应遵循返回*this的reference的“协议”(无强制性)，以应对连等情况出现。</li>
</ol>
<h2 id="Item-11：在-operator-中处理“自我赋值”"><a href="#Item-11：在-operator-中处理“自我赋值”" class="headerlink" title="Item 11：在 operator= 中处理“自我赋值”"></a>Item 11：在 operator= 中处理“自我赋值”</h2><ol>
<li><p>注：自我赋值不但包括明显的自我赋值(如w = w)，还包括潜在的自我赋值(比如a[i] = a[j], *pi = *pj等).甚至一个指向子类对象的基类指针和子类对象指针也是自我赋值。</p>
</li>
<li><p>处理“自我赋值”的三种方案：</p>
<p> 假设如下两个类：</p>
<pre><code> class Bitmap{...};
 class Widget{
   ...
 private:
   Bitmap *pb;
 };</code></pre><p>   一份不安全的operator=实现版本</p>
<pre><code> Widget&amp; Widget::operator=(const Widget&amp; rhs){
   delete pb;
   pb = new Bitmap(*rhs.pb);
   return *this;
 }</code></pre><p>   这里自我赋值的问题：*this和rhs有可能是同一个对象，delete pb时可能将rhs的pb销毁。</p>
<p>   以下是三种方案</p>
<ul>
<li><p>传统做法：在operator=最前面加一个“证同测试(identity test)”检验：</p>
<pre><code>Widget&amp; Widget::operator=(const Widget&amp; rhs){
  if(*this == &amp;rhs) return *this;
  delete pb;
  pb = new Bitmap(*rhs.pb);
  return *this;
} </code></pre><p>优点：简单，行得通</p>
<p>缺点：无“异常安全性”，如果new Bitmap有异常，Widget会持有一个指针指向一块被删除的Bitmap，且该指针无法被删除或者安全读取。</p>
</li>
<li><p>调整语句顺序：</p>
<pre><code>Widget&amp; Widget::operator=(const Widget&amp; rhs){
  Bitmap *pOrig = pb;
  pb = new Bitmap(*rhs.pb);
  delete pOrig;
  return *this;
} </code></pre><p>优点：无“异常安全性”</p>
<p>缺点：不是处理这个问题的最高效方法</p>
</li>
<li><p>copy and swap技术：</p>
<pre><code>//不具有清晰性，暂略。</code></pre><p>优点:</p>
<p>缺点：</p>
</li>
</ul>
</li>
</ol>
<h2 id="Item-12：复制对象时勿忘其每一个成分"><a href="#Item-12：复制对象时勿忘其每一个成分" class="headerlink" title="Item 12：复制对象时勿忘其每一个成分"></a>Item 12：复制对象时勿忘其每一个成分</h2><ol>
<li><p>如果为class添加一个成员变量，必须同时修改coping函数。(同时也需修改class所有的构造函数以及任何非标准形式的operator=，如+=)</p>
</li>
<li><p>当一个类是子类并且为其撰写copying函数时，必须很小心地也复制其父类成分。由于成员变量一般是private，所以无法直接访问它们，应该让子类地copying函数调用相应地父类函数：</p>
<ul>
<li>构造时在member initialization list调用父类构造函数。</li>
<li>在重载operator=时调用BaseClass::operator=(rhs);</li>
</ul>
</li>
<li><p>拷贝构造和拷贝赋值互相调用都是不合理的，理由如下：</p>
<ul>
<li>拷贝赋值操作符调用拷贝构造就像在试图构造一个已经存在的对象。</li>
<li>拷贝构造函数不能调用拷贝赋值，因为构造函数用来初始化新对象，而赋值操作符只实行于已初始化对象身上。</li>
</ul>
</li>
<li><p>如果发现拷贝构造和拷贝赋值中有相近代码，消除这些重复代码的做法是建立一个新的成员函数给两者调用，通常这个函数是private并且命名为init。</p>
</li>
</ol>
</article><div id="paginator"></div></div><footer id="bottom"><span>© </span><span>Li Xuetao</span><span>. Powered By </span><a href="http://hexo.io"><span>HEXO</span></a><span>. Theme </span><a href="https://github.com/lixuetaoleo/hexo-theme-leo">leo</a></footer></div><script src="/js/style.js"></script><script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script></body></html>